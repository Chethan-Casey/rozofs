Summary: RozoFS scale-out NAS
Name: rozofs
Version: @VERSION@
Release:1
License: GPLv2
Group: System Environment/Base
Vendor: Fizians SAS
Packager: users@rozofs.org
URL: http://www.rozofs.org
Source0: rozofs-@VERSION@.tar.gz
Requires(post): /sbin/chkconfig
Requires(preun): /sbin/service, /sbin/chkconfig
Requires(postun): /sbin/service

# Manage by cmake
#BuildRequires: gcc make automake cmake
#BuildRequires:
#BuildRequires: python-devel

%description
Rozofs is a scale-out NAS using erasure coding.

%package exportd
Summary: Rozofs filesystem (export package).
License: GPLv2
Group: System Environment/Daemons
BuildRequires: libattr-devel libconfig-devel
Requires: rpcbind, libattr, libconfig

%description exportd
Rozofs is a scale-out NAS using erasure coding.

%package storaged
Summary: Rozofs filesystem (storage package).
License: GPLv2
Group: System Environment/Daemons
BuildRequires: libconfig-devel
Requires: rpcbind libconfig

%description storaged
Rozofs is a scale-out NAS using erasure coding.

%package rozofsmount
Summary: Rozofs filesystem (rozofsmount package).
License: GPLv2
Group: System Environment/File
BuildRequires: fuse-devel
Requires: fuse-libs

%description rozofsmount
Rozofs is a scale-out NAS using erasure coding.

%package rprof
Summary: Rozofs filesystem (profiling package).
License: GPLv2
Group: System Environment/File
#BuildRequires:
#Requires:

%description rprof
Rozofs is a scale-out NAS using erasure coding.

%package manager-lib
Summary: Rozofs filesystem (management library package).
License: GPLv2
Group: System Environment/File
#BuildRequires:
Requires: libconfig, pyro, python-argparse

%description manager-lib
Rozofs is a scale-out NAS using erasure coding.

%package manager-cli
Summary: Rozofs filesystem (management cli package).
License: GPLv2
Group: System Environment/File
#BuildRequires:
Requires: rozofs-manager-lib

%description manager-cli
Rozofs is a scale-out NAS using erasure coding.

%package manager-agent
Summary: Rozofs filesystem (management agent package).
License: GPLv2
Group: System Environment/File
#BuildRequires:
Requires: rozofs-manager-cli

%description manager-agent
Rozofs is a scale-out NAS using erasure coding.

%prep
%setup -q

%build
export CFLAGS="-D_GNU_SOURCE"
export CXXFLAGS="-D_GNU_SOURCE"
CMAKE_EXTRA_FLAGS="-DCMAKE_SKIP_RPATH=ON\
                  -DCMAKE_BUILD_TYPE:STRING=RelWithDebInfo\
                  -DCMAKE_INSTALL_PREFIX:STRING=/usr\
                  -DSYSCONFDIR:STRING=/etc"
cmake -G "Unix Makefiles" ${CMAKE_EXTRA_FLAGS}

%{__make}

%install
rm -rf %{buildroot}/*
make install DESTDIR=%{buildroot}
#install init script
mkdir -p %{buildroot}/etc/init.d
mkdir -p %{buildroot}/etc/default
%{__cp} @CMAKE_CURRENT_SOURCE_DIR@/redhat/rozofs-exportd %{buildroot}%{_initrddir}/rozofs-exportd
%{__cp} @CMAKE_CURRENT_SOURCE_DIR@/redhat/rozofs-storaged %{buildroot}%{_initrddir}/rozofs-storaged
%{__cp} @CMAKE_CURRENT_SOURCE_DIR@/redhat/rozofs-rozofsmount %{buildroot}%{_initrddir}/rozofs-rozofsmount
%{__cp} @CMAKE_CURRENT_SOURCE_DIR@/redhat/rozofs-manager-agent %{buildroot}%{_initrddir}/rozofs-manager-agent
%{__cp} @CMAKE_CURRENT_SOURCE_DIR@/redhat/rozofs-manager-agent.default %{buildroot}%{_sysconfdir}/default/rozofs-manager-agent

%clean
%{__rm} -rf %{buildroot}

%files exportd
%defattr(-,root,root)
%{_bindir}/exportd
%{_sysconfdir}/rozofs/export.conf
%{_sysconfdir}/rozofs/export.conf.sample
%{_initrddir}/rozofs-exportd
%{_mandir}/man5/export.conf.5.gz
%{_mandir}/man7/rozofs.7.gz
%{_mandir}/man8/exportd.8.gz

%files storaged
%defattr(-,root,root)
%{_bindir}/storaged
%{_sysconfdir}/rozofs/storage.conf
%{_sysconfdir}/rozofs/storage.conf.sample
%{_initrddir}/rozofs-storaged
%{_mandir}/man5/storage.conf.5.gz
%{_mandir}/man8/storaged.8.gz

%files rozofsmount
%defattr(-,root,root)
%{_bindir}/rozofsmount
%{_initrddir}/rozofs-rozofsmount
%{_mandir}/man8/rozofsmount.8.gz

%files rprof
%defattr(-,root,root)
%{_bindir}/rprof

%files manager-lib
%defattr(-,root,root)
/usr/lib/python2.6/site-packages/rozofs/cli/platform.py
/usr/lib/python2.6/site-packages/rozofs/cli/agent.py
/usr/lib/python2.6/site-packages/rozofs/cli/__init__.py
/usr/lib/python2.6/site-packages/rozofs/cli/parser.py
/usr/lib/python2.6/site-packages/rozofs/ext/__init__.py
/usr/lib/python2.6/site-packages/rozofs/ext/fstab.py
/usr/lib/python2.6/site-packages/rozofs/__init__.py
/usr/lib/python2.6/site-packages/rozofs/core/platform.py
/usr/lib/python2.6/site-packages/rozofs/core/agent.py
/usr/lib/python2.6/site-packages/rozofs/core/_profile.so
/usr/lib/python2.6/site-packages/rozofs/core/libconfig.py
/usr/lib/python2.6/site-packages/rozofs/core/storaged.py
/usr/lib/python2.6/site-packages/rozofs/core/__init__.py
/usr/lib/python2.6/site-packages/rozofs/core/_libconfig.so
/usr/lib/python2.6/site-packages/rozofs/core/daemon.py
/usr/lib/python2.6/site-packages/rozofs/core/configuration.py
/usr/lib/python2.6/site-packages/rozofs/core/constants.py
/usr/lib/python2.6/site-packages/rozofs/core/exportd.py
/usr/lib/python2.6/site-packages/rozofs/core/profile.py
/usr/lib/python2.6/site-packages/rozofs/core/share.py
%exclude /usr/lib/python2.6/site-packages/rozofs/cli/platform.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/cli/agent.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/cli/__init__.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/cli/parser.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/ext/__init__.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/ext/fstab.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/__init__.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/core/platform.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/core/agent.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/core/libconfig.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/core/storaged.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/core/__init__.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/core/daemon.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/core/configuration.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/core/constants.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/core/exportd.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/core/profile.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs/core/share.pyc
%exclude /usr/lib/python2.6/site-packages/rozofs_manager-@VERSION@-py2.6.egg-info

%files manager-cli
%defattr(-,root,root)
%{_bindir}/rozo

%files manager-agent
%defattr(-,root,root)
%{_sysconfdir}/default/rozofs-manager-agent
%{_sysconfdir}/rozofs/platform.conf
%{_sysconfdir}/rozofs/sharing.conf
%{_initrddir}/rozofs-manager-agent

%post exportd
/sbin/chkconfig --add rozofs-exportd

%post storaged
/sbin/chkconfig --add rozofs-storaged

%post rozofsmount
ln -sf /sbin/mount.fuse /sbin/mount.rozofs
/sbin/chkconfig --add rozofs-rozofsmount

%post manager-agent
/sbin/chkconfig --add rozofs-manager-agent

%changelog

* Tue Feb 05 2013 RozoFS <rd@rozofs.org> - 1.0.2
- Initial spec file
