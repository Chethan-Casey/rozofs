if(DEBUILD-NOTFOUND)
    message(FATAL_ERROR "Cannot find debuild.")
endif(DEBUILD-NOTFOUND)

set(TGZ_PACKAGE "@CMAKE_CURRENT_BINARY_DIR@/@ROZOFS_SOURCE_PACKAGE_FILE_NAME@.tar.gz")
set(TGZ_PACKAGE_ORIG "@CMAKE_CURRENT_BINARY_DIR@/rozofs_@VERSION@.orig.tar.gz")

if(NOT EXISTS ${TGZ_PACKAGE})
    message(FATAL_ERROR "Cannot find ${TGZ_PACKAGE}: please run package_source target.")
endif(NOT EXISTS ${TGZ_PACKAGE})

if(EXISTS @CMAKE_CURRENT_BINARY_DIR@/@ROZOFS_SOURCE_PACKAGE_FILE_NAME@)
    execute_process(COMMAND rm -rf @CMAKE_CURRENT_BINARY_DIR@/@ROZOFS_SOURCE_PACKAGE_FILE_NAME@)
endif(EXISTS @CMAKE_CURRENT_BINARY_DIR@/@ROZOFS_SOURCE_PACKAGE_FILE_NAME@)

execute_process(COMMAND cp ${TGZ_PACKAGE} ${TGZ_PACKAGE_ORIG})
execute_process(COMMAND tar -zxvf ${TGZ_PACKAGE})
execute_process(COMMAND cp debian/control.debian debian/control WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@/@ROZOFS_SOURCE_PACKAGE_FILE_NAME@)
execute_process(COMMAND debuild -us -uc -b WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@/@ROZOFS_SOURCE_PACKAGE_FILE_NAME@)